{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta property="og:url"                content="https://www.odso.kr" />
    <meta property="og:type"               content="website" />
    <meta property="og:title"              content="오디써:경기도 지역화폐 가맹점 지도" />
    <meta property="og:description"        content="경기도 지역화폐 가맹점 지도" />
    <meta property="og:image"              content="{% static 'image/ogimage.png' %}" />
    <title>오디써</title>
    <meta name="description" content="경기도 지역화폐 가맹점 지도">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}" type="image/x-icon"/>
    <!---->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="{% static 'css/mapstyle.css' %}"> <!--지도적용-->
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/moonspam/NanumSquare/master/nanumsquare.css"> <!--나눔스퀘어 폰트-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"> <!--부트스트랩-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3ee8e0692190c94bbe63d42f7dbe7aeb&libraries=services,clusterer,drawing"></script> <!--지도API-->
    <script src="https://code.jquery.com/jquery-1.11.0.js"></script> <!--현위치 받기, 내용 없애기-->
</head>

<body>
    <div id="map" onclick="detail_hide();"></div> 

    <!-- nav바: 뒤로가기, 검색창 -->
    <div class="nav"> 
        <div id="nav_button">
            <a href="{% url 'home' %}"><img src="{% static 'image/back.png' %}" height="60%"></a>
        </div> 
        <div class="search">
            <input id="input" type="text" placeholder="가게명/주소/업종 키워드2개" maxlength="20">
            <input type="submit" id="search_button" onclick="search();" value="검색">
        </div>
    </div>

    <!-- 검색결과 -->
    <div class="search_result" id="result">
        <div class="scrollBlind" style="display:none" id="sb">
            <ul class="list-group" id="lg"></ul>
        </div>
    </div>
    
    <!-- 현위치 -->
    <img src="{% static 'image/renew.png' %}" id="current" style="margin: 2px 2px 0 0;" onclick="get_current_location();">

    <!-- 상세페이지 -->
    <div id="city" style="display:none"></div>
    <div id="detail" style="display:none">
        <div class="scrollBlind" style="display:none" id="dsb">
            <ul class="list-group" id="dlg"></ul>
        </div>
    </div>
    <script>
        // Get current position from query string
        temp = location.href.split("?");
        if (temp) {
            data = temp[1].split(",");
            current_lat = data[0];
            current_lon = data[1];
        } else { // 경기도청 좌표
            current_lat = 37.275050;
            current_lon = 127.009447;
        }

        // Set initialize map
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(current_lat, current_lon),
            level: 2
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        map.setMaxLevel(6);

        // Set marker initialize position in map
        var imageSrc = "{% static 'image/current.png' %}";
        var imageSize = new kakao.maps.Size(50, 50);
        new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(current_lat, current_lon),
            image: new kakao.maps.MarkerImage(imageSrc, imageSize),
        });

        // Clusterer in map
        var clusterer = new kakao.maps.MarkerClusterer({
            map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
            averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
            minLevel: 2, // 클러스터 할 최소 지도 레벨
            minClusterSize: 1,
            calculator: [50, 100, 150, 300]
        });

        // Set marker
        // default marker
        var normalImage = new kakao.maps.MarkerImage(
            // 마커이미지의 주소
            '{% static "image/marker1.png" %}',
            // 마커이미지의 크기
            new kakao.maps.Size(43, 44),
            // 마커이미지의 옵션, 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정
            {offset: new kakao.maps.Point(12, 42.4)}
        );

        // clicked marker
        var clickImage = new kakao.maps.MarkerImage(
            // 클릭 마커이미지의 주소
            '{% static "image/marker2.png" %}',
            // 클릭 마커이미지의 크기
            new kakao.maps.Size(47.6, 62),
            // 클릭 마커이미지의 옵션, 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정
            {offset: new kakao.maps.Point(26, 60.4)}
        );

        var positions = [];
        var markers = [];
        var preMarkers = [];

        ///// Get data from DB (current position)
        var bounds = map.getBounds();
        putData(
            bounds.getSouthWest().Ha, bounds.getSouthWest().Ga,
            bounds.getNorthEast().Ha, bounds.getNorthEast().Ga
        );

        ///// Add Listener
        kakao.maps.event.addListener(map, 'dragend', function() { // 지도가 이동, 확대 또는 축소되면 마지막 파라미터로 넘어온 함수를 호출하도록 이벤트를 등록합니다
            detail_hide();
            var bounds = map.getBounds();
            putData(
                bounds.getSouthWest().Ha, bounds.getSouthWest().Ga,
                bounds.getNorthEast().Ha, bounds.getNorthEast().Ga
            );
        });

        ///// Add Listener
        kakao.maps.event.addListener(map, 'zoom_changed', function() {
            detail_hide();
            var bounds = map.getBounds();
            putData(
                bounds.getSouthWest().Ha, bounds.getSouthWest().Ga,
                bounds.getNorthEast().Ha, bounds.getNorthEast().Ga
            );
        });

        async function putData(sw_latitude, sw_longitude, ne_latitude, ne_longitude){
            let responses = await getStoreList(sw_latitude, sw_longitude, ne_latitude, ne_longitude);
            if (responses){
                positions = [];
                if (positions.length === 0){
                    $.each(responses, function (key, value) {
                        positions.push({
                            'id': value.id,
                            'city_id': value.city_id,
                            'info': value.name + ' ' + value.industry_name + ' ' + value.refine_road_address,
                            'position': new kakao.maps.LatLng(value.latitude, value.longitude),
                            'content':
                                '<div id="ti">' +
                                '<div id="title" onclick="marker_info(' + value.latitude + ', ' + value.longitude + ');">' + value.name + '</div>' +
                                '<div id="industry">' + value.industry_name + '</div>' +
                                '</div>' +
                                '<div id="address">' + value.refine_road_address + '</div>' +
                                '<div id="num">' + value.phone + '</div>',
                        });
                    });
                    clusterer.clear();
                    showMarker();
                    hideMarker();
                }
            }
        }

        function getStoreList(sw_latitude, sw_longitude, ne_latitude, ne_longitude){
            return new Promise(function(resolve, reject){
                $.getJSON("https://www.odso.kr/api/v1/stores/", //DB
                // $.getJSON("http://127.0.0.1:8000/api/v1/stores/", //DB
                {
                    sw_latitude: sw_latitude,
                    sw_longitude: sw_longitude,
                    ne_latitude: ne_latitude,
                    ne_longitude: ne_longitude
                },
                function (response) {
                    resolve(response);
                });
            });
        }

        function showMarker(){
            preMarkers = markers.slice();
            markers = [];
            for (let i = 0; i < positions.length; i++) {
                addMarker(positions[i].id, positions[i].city_id, positions[i].position);
            }
            clusterer.addMarkers(markers);
        }

        function hideMarker(){
            for (let i = 0; i < preMarkers.length; i++) {
                preMarkers[i].setMap(null);
            }
            preMarkers = [];
        }

        var selectedMarker = null; // 클릭한 마커를 담을 변수
        function addMarker(store_id, city_id, position) {  // 마커를 생성하고 지도 위에 표시하고, 마커에 click 이벤트를 등록하는 함수입니다
            let marker = new kakao.maps.Marker({ // 마커를 생성하고 이미지는 기본 마커 이미지를 사용합니다
                map: map,
                position: position,
                image: normalImage,
            });

            // 마커 객체에 마커아이디와 마커의 기본 이미지를 추가합니다
            marker.normalImage = normalImage;

            // 마커에 click 이벤트를 등록합니다
            if (map.getLevel() <= 3) {
                kakao.maps.event.addListener(marker, 'click', function() {
                    $(function(){ $('#dlg').empty();}); //이전 내용 지우기
                    if (!selectedMarker || selectedMarker !== marker) {
                        // 클릭된 마커 객체가 null이 아니면
                        // 클릭된 마커의 이미지를 기본 이미지로 변경하고
                        !!selectedMarker && selectedMarker.setImage(selectedMarker.normalImage);
                    }
                    // 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
                    selectedMarker = marker;

                    // 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
                    marker.setImage(clickImage);

                    for (let i = 0; i < positions.length; i ++) {
                        if (positions[i].position.equals(position)) {
                            detail_show(positions[i].content);
                            city_show(positions[i].city_id);
                        }
                    }
                    result.style.display = "none";
                });
            }
            markers.push(marker);
        }

        function detail_show(content) { //detail 보이기
            detail.style.display = "";
            dsb.style.display = "";
            $("#dlg").append("<li id='detail_li'>" + content + "</li>");
        }

        function city_show(code) { //city 정보 보이기
            city.style.display = "";
            if (code){
                document.all("city").innerHTML='<div class="city'+code+'"></div>';
            }
        }

        // 가게명 눌렀을 때 해당 마커로 지도 이동 & 정보 띄우기
        function marker_info(latitude, longitude){
            $(function(){ $('#dlg').empty();}); //이전 내용 지우기
            var clickedPosition = new kakao.maps.LatLng(latitude, longitude);
            map.setCenter(clickedPosition);
            map.setLevel(1);

            let marker = new kakao.maps.Marker({ // 마커를 생성하고 이미지는 기본 마커 이미지를 사용합니다
                map: map,
                position: clickedPosition,
                image: normalImage,
            });
            marker.normalImage = normalImage;

            if (!selectedMarker || selectedMarker !== marker) {
                // 클릭된 마커 객체가 null이 아니면
                // 클릭된 마커의 이미지를 기본 이미지로 변경하고
                !!selectedMarker && selectedMarker.setImage(selectedMarker.normalImage);
            }
            // 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
            selectedMarker = marker;

            // 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
            marker.setImage(clickImage);

            markers.push(marker);

            for (let i = 0; i < positions.length; i ++) {
                if (positions[i].position.equals(clickedPosition)) {
                    detail_show(positions[i].content);
                    city_show(positions[i].city_id);
                }
            }
            result.style.display = "none";
        }

        // 상세정보 닫기
        function detail_hide() { //detail, city, result 숨기기
            $(function(){ $('#dlg').empty();}); //이전 내용 지우기
            detail.style.display = "none";
            city.style.display = "none";
            result.style.display = "none";
            current.style.display = "";

            if (selectedMarker){
                selectedMarker.setImage(selectedMarker.normalImage);
                selectedMarker = null;
            }
        }

    /////////// 검색 ///////////
    function addResult(content) { // 검색결과 추가
        $("#lg").append("<li class='list-group-item' id='sr'>" + content + "</li>");
    }
    function search(){
        // 이전내용 지우기
        $(function(){$('#lg').empty();});

        // 결과창 띄우기, detail 숨기기
        detail.style.display = "none";
        city.style.display = "none";
        result.style.display = "";
        sb.style.display = "";

        // 검색어 받기
        let inputs = document.getElementById("input").value.split(" ");

        let count = 0;
        for (let i = 0; i < positions.length; i++){
            if (inputs[1]) {
                if(positions[i].info.indexOf(inputs[0])!== -1 && positions[i].info.indexOf(inputs[1])!== -1){
                    addResult(positions[i].content);
                    count++;
                }
            } else if (positions[i].info.indexOf(inputs[0])!== -1 ) {
                addResult(positions[i].content);
                count++;
            }
        }
        if (count === 0) {
            alert("현재 영역에서 검색에 만족하는 상점이 없습니다.");
        }
    }
            
    function get_current_location() {  //현위치 다시받기
        if (navigator.geolocation) {
            //위치 정보를 얻기
            navigator.geolocation.getCurrentPosition (function(pos) {
                location.href="?" + pos.coords.latitude + "," + pos.coords.longitude;
            });
        } else { // 디폴트위치: 경기도청
            alert("현 위치를 받을 수 없습니다.");
            location.href="?37.275050,127.009447";
        }
    }
</script>
</body>
</html>